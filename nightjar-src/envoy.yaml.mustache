---

static_resources:
  listeners:
{{#listeners}}
    - address:
        socket_address:
          address: "0.0.0.0"
          port_value: {{mesh_port}}
      filter_chains:
      - filters:
        - name: envoy.http_connection_manager
          typed_config:
            "@type": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
            codec_type: auto
            stat_prefix: ingress_http
            http_filters:
            - name: envoy.router
              typed_config: {}
            route_config:
              name: local_route
              virtual_hosts:
              - name: backend
                domains:
                - "*"
                routes:
                - match:
                    path: {{healthcheck_path}}
                  direct_response:
                    status: "200"
                    body:
                      inline_string: "ok"
                  response_headers_to_add:
                    - header:
                        key: "Content-type"
                        value: "text/plain"
                {{#routes}}
                - match:
                    prefix: {{route_path}}
                    route:
                    {{#has_one_cluster}}
                    {{#clusters}}
                        cluster: {{cluster_name}}
                    {{/clusters}}
                    {{/has_one_cluster}}
                    {{#has_many_clusters}}
                        weighted_clusters:
                          total_weight: {{total_cluster_weight}}
                          clusters:
                          {{#clusters}}
                            - name: {{cluster_name}}
                              weight: {{route_weight}}
                          {{/clusters}}
                    {{/has_many_clusters}}
                {{/routes}}

{{/listeners}}

{{#has_clusters}}
  clusters:
    {{#clusters}}
    - name: {{name}}
      connect_timeout: 300s
      # The Service Discovery registration connects through IP addresses.
      type: static
      dns_lookup_family: V4_ONLY
      lb_policy: round_robin
      {{#uses_http2}}
      # Enabling http2_protocol_options means forcing connections to the cluster as http/2 requests.
      http2_protocol_options: {}
      {{/uses_http2}}
      load_assignment:
        cluster_name: {{name}}
        endpoints:
          - lb_endpoints:
            {{#endpoints}}
            - endpoint:
                address:
                  socket_address:
                    address: "{{ipv4}}"
                    port_value: {{port}}
            {{/endpoints}}

    {{/clusters}}
{{/has_clusters}}
admin:
  access_log_path: "/dev/stdout"
  address:
    socket_address:
      address: 0.0.0.0
      port_value: {{admin_port}}
